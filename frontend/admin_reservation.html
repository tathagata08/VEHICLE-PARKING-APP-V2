<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Parking Lots - Quickpark</title>
<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
    body { background-color: #fff4f4; font-family: Arial, sans-serif; }
    header { background: #b34747; color: white; padding: 1rem; text-align: center; position: relative; }
    header button { position: absolute; right: 20px; top: 10px; }
    .card { border-radius: 12px; box-shadow: 0 3px 6px rgba(0,0,0,0.15); margin-bottom: 15px; }
    .slot-circle { display: inline-block; width: 18px; height: 18px; border-radius: 50%; margin: 3px; line-height: 18px; text-align: center; color: white; font-size: 10px; font-weight: bold; }
    .free { background-color: green; }
    .occupied { background-color: red; }
    .btn-small { font-size: 0.8rem; padding: 2px 6px; margin-left: 5px; }
    footer { background: #b34747; color: white; text-align: center; padding: 0.8rem; margin-top: 30px; }
</style>
</head>
<body>
<div id="app">
    <header>
        <h2>Admin - Parking Lots</h2>
        <button class="btn btn-light btn-sm" @click="logout">Logout</button>
    </header>

    <div class="container mt-4">
        <div class="row">
            <!-- Left: Parking lot cards -->
            <div class="col-md-7">
                <div class="mb-3">
                    <input type="text" class="form-control" placeholder="Search Parking Lots..." v-model="searchQuery">
                </div>
                <div class="row">
                    <div class="col-md-12" v-for="lot in filteredParkingLots" :key="lot.lotid">
                        <div class="card p-3">
                            <h5>{{ lot.location }}
                                <button class="btn btn-primary btn-small" @click="editLot(lot)">Edit</button>
                                <button class="btn btn-warning btn-small" 
                                        @click="togglePauseLot(lot)">
                                    {{ lot.is_paused ? 'Resume' : 'Pause' }}
                                </button>
                                <button class="btn btn-danger btn-small" @click="deleteLot(lot.lotid)">Delete</button>
                            </h5>

                            <p>{{ lot.address }} | PIN: {{ lot.pin }}</p>
                            <p>Slots: {{ lot.no_of_slot }}</p>
                            <div>
                                <span v-for="slot in lot.slots" :key="slot.spotid"
                                      :class="['slot-circle', slot.status ? 'occupied' : 'free']">
                                    {{ slot.spotid }}
                                </span>
                            </div>
                        </div>
                    </div>
                    <div v-if="filteredParkingLots.length === 0" class="col-12">
                        <p class="text-muted text-center">No parking lots found.</p>
                    </div>
                </div>
            </div>

            <!-- Right: Add/Edit lot form -->
            <div class="col-md-5">
                <div class="card p-3">
                    <h4>{{ editingLot ? 'Edit Parking Lot' : 'Add New Parking Lot' }}</h4>
                    <form @submit.prevent="editingLot ? updateLot() : createLot()">
                        <div class="mb-3">
                            <label class="form-label">Location</label>
                            <input type="text" class="form-control" v-model="lotForm.location" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Address</label>
                            <input type="text" class="form-control" v-model="lotForm.address" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">PIN</label>
                            <input type="text" class="form-control" v-model="lotForm.pin" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Number of Slots</label>
                            <input type="number" class="form-control" v-model="lotForm.no_of_slot" min="1" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Price per Slot</label>
                            <input type="number" class="form-control" v-model="lotForm.price" min="1" required>
                        </div>
                        <button type="submit" class="btn btn-success w-100">{{ editingLot ? 'Update Lot' : 'Create Lot' }}</button>
                        <button v-if="editingLot" type="button" class="btn btn-secondary w-100 mt-2" @click="cancelEdit">Cancel</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<footer>
    &copy; 2025 Quickpark
</footer>

<script>
const { createApp } = Vue;

createApp({
    data() {
        return {
            parkingLots: [],
            lotForm: { location:'', address:'', pin:'', no_of_slot:1, price:0 },
            editingLot: null,
            searchQuery: ''
        }
    },
    mounted() {
        this.fetchParkingLots();
    },
    computed: {
        filteredParkingLots() {
            if(!this.searchQuery) return this.parkingLots;
            const q = this.searchQuery.toLowerCase();
            return this.parkingLots.filter(lot => 
                lot.location.toLowerCase().includes(q) ||
                lot.address.toLowerCase().includes(q) ||
                String(lot.pin).includes(q)
            );
        }
    },
    methods: {
        async fetchParkingLots() {
            const token = localStorage.getItem("admin_token");
            if (!token) {
                alert("Please login first.");
                window.location.href = "admin_login.html";
                return;
            }

            try {
                const res = await fetch("http://127.0.0.1:5000/admin/parkinglots", {
                    headers: { "Authorization": "Bearer " + token }
                });

                const data = await res.json();

                if (res.ok) {
                    this.parkingLots = data.parkingLots.map(lot => ({
                        ...lot,
                        is_paused: String(lot.is_paused) === "1"
                    }));
                } else {
                    alert(data.error || "Failed to fetch lots");
                }
            } catch (err) {
                console.error(err);
                alert("Server error");
            }
        },

        async createLot() {
            const token = localStorage.getItem("admin_token");
            if(!token) return;
            try {
                const res = await fetch("http://127.0.0.1:5000/admin/parkinglots", {
                    method: "POST",
                    headers: { "Content-Type":"application/json", "Authorization":"Bearer " + token },
                    body: JSON.stringify(this.lotForm)
                });
                const data = await res.json();
                if(res.ok) {
                    alert("Parking lot created!");
                    this.lotForm = { location:'', address:'', pin:'', no_of_slot:1, price:0 };
                    this.fetchParkingLots();
                } else alert(data.error || "Failed to create lot");
            } catch(err) { console.error(err); alert("Server error"); }
        },

        editLot(lot) {
            this.editingLot = lot;
            this.lotForm = { ...lot };
        },
        cancelEdit() {
            this.editingLot = null;
            this.lotForm = { location:'', address:'', pin:'', no_of_slot:1, price:0 };
        },

        async updateLot() {
            const token = localStorage.getItem("admin_token");
            if(!token) return;
            try {
                const res = await fetch(`http://127.0.0.1:5000/admin/parking_lot/${this.editingLot.lotid}`, {
                    method: "PUT",
                    headers: { "Content-Type":"application/json", "Authorization":"Bearer " + token },
                    body: JSON.stringify(this.lotForm)
                });
                const data = await res.json();
                if(res.ok) {
                    alert("Parking lot updated!");
                    this.cancelEdit();
                    this.fetchParkingLots();
                } else alert(data.error || "Failed to update lot");
            } catch(err) { console.error(err); alert("Server error"); }
        },

        async deleteLot(lotid) {
            if(!confirm("Are you sure to delete this lot?")) return;
            const token = localStorage.getItem("admin_token");
            if(!token) return;
            try {
                const res = await fetch(`http://127.0.0.1:5000/admin/parkinglots/${lotid}`, {
                    method: "DELETE",
                    headers: { "Authorization":"Bearer " + token }
                });
                const data = await res.json();
                if(res.ok) {
                    alert("Parking lot deleted!");
                    this.fetchParkingLots();
                } else alert(data.error || "Failed to delete lot");
            } catch(err) { console.error(err); alert("Server error"); }
        },

        async togglePauseLot(lot) {
            const token = localStorage.getItem("admin_token");
            if (!token) return;

            try {
                const res = await fetch(
                    `http://127.0.0.1:5000/admin/parking_lot/${lot.lotid}/pause`,
                    {
                        method: "PUT",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": "Bearer " + token
                        },
                        body: JSON.stringify({ is_paused: !lot.is_paused })
                    }
                );

                const data = await res.json();

                if (res.ok) {
                    lot.is_paused = data.is_paused;
                } else {
                    alert(data.error);
                }

            } catch (err) {
                console.error(err);
                alert("Server error");
            }
        },

        logout() {
            localStorage.removeItem("admin_token");
            window.location.href = "admin_login.html";
        }
    }
}).mount("#app");
</script>
</body>
</html>
