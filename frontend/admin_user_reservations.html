<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>User Reservation History</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-light">
<div id="app" class="container mt-4">

    <h2 class="text-center mb-4">User Reservation History</h2>

    <div v-if="loading" class="alert alert-info">Loading...</div>

    <div v-else-if="reservations.length === 0" class="alert alert-warning text-center">
        No reservations found.
    </div>

    <div v-else>
        <table class="table table-striped table-bordered">
            <thead class="table-dark">
            <tr>
                <th>Vehicle Number</th>
                <th>Lot</th>
                <th>Spot</th>
                <th>Reserved</th>
                <th>Duration</th>
                <th>Cost</th>
                <th>Status</th>
            </tr>
            </thead>

            <tbody>
            <tr v-for="r in reservations" :key="r.id">
                <td>{{ r.vehicle_number }}</td>
                <td>LOT-{{ r.lot_id }}</td>
                <td>{{ r.spot_id }}</td>
                <td>{{ formatTimeRange(r.reserved_at, r.released_at) }}</td>
                <td>{{ formatDuration(r.reserved_at, r.released_at) }}</td>
                <td>{{ r.total_cost || 0 }}</td>
                <td>
                    <span v-if="!r.released_at" class="text-danger fw-bold">Active</span>
                    <span v-else class="text-success">Released</span>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- Charts -->
    <h3 class="mt-4 text-center">User Parking Stats</h3>
    <div class="row mt-3">
        <div class="col-md-6">
            <canvas id="statusPieChart"></canvas>
        </div>
        <div class="col-md-6">
            <canvas id="occupancyLineChart"></canvas>
        </div>
        <h3 class="mt-4 text-center">Your Revenue Stats</h3>
<canvas id="revenueChart" width="400" height="200" class="mt-3"></canvas>

    </div>

</div>

<script>
const { createApp } = Vue;

createApp({
    data() {
        return {
            token: localStorage.getItem("admin_token"), // ONLY ADMIN TOKEN
            reservations: [],
            loading: true,
            uid: new URLSearchParams(window.location.search).get("uid")
        };
    },

    methods: {
        async loadReservations() {
            const url = `http://127.0.0.1:5000/admin/user/${this.uid}/history`;

            const res = await fetch(url, {
                headers: { "Authorization": `Bearer ${this.token}` }
            });

            if (!res.ok) {
                console.error("Failed to fetch admin user reservations");
                this.loading = false;
                return;
            }

            const data = await res.json();
            this.reservations = data.history || [];
            this.loading = false;
        },

        formatTimeRange(startStr, endStr) {
            if (!startStr) return "";
            const s = new Date(startStr);
            s.setTime(s.getTime() + 19800000);
            const p = n => String(n).padStart(2, "0");
            const st = `${p(s.getHours())}:${p(s.getMinutes())}:${p(s.getSeconds())}`;
            if (!endStr) return `${st} - Ongoing`;
            const e = new Date(endStr);
            e.setTime(e.getTime() + 19800000);
            const et = `${p(e.getHours())}:${p(e.getMinutes())}:${p(e.getSeconds())}`;
            return `${st} - ${et}`;
        },

        formatDuration(startStr, endStr) {
            if (!startStr) return "";
            if (!endStr) return "Ongoing";
            const diff = (new Date(endStr) - new Date(startStr)) / 1000;
            const h = Math.floor(diff / 3600);
            const m = Math.floor((diff % 3600) / 60);
            const s = Math.floor(diff % 60);
            return `${h}h ${m}m ${s}s`;
        }
    },

    mounted() {
        if (!this.token) window.location.href = "admin_login.html";
        this.loadReservations();
    }

}).mount("#app");
</script>

<!-- Include chart script after the DOM -->
<script src="user_stat.js"></script>

</body>
</html>
