<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Reserve Parking</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">
<div id="app" class="container mt-4">

    <h2 class="text-center mb-3">Reserve a Parking Spot</h2>

    <div class="row">
        <!-- LEFT COLUMN: Parking Lots -->
        <div class="col-md-6">
            <div class="mb-3">
                <input type="text" class="form-control" placeholder="Search parking lots..." v-model="lotSearchQuery">
            </div>

            <div v-if="filteredLots.length === 0" class="alert alert-info text-center">
                No parking lots found...
            </div>

            <div class="row" v-else>
                <div class="col-md-12 mb-3" v-for="lot in filteredLots" :key="lot.lot_id">
                    <div class="card p-3 shadow-sm">
                        <h5>{{ lot.location }}</h5>
                        <p>Vacant: <b>{{ lot.vacant_spots }}</b></p>
                        <p>Price/hr: ₹{{ lot.price }}</p>

                        <button class="btn btn-success w-100"
                                :disabled="lot.vacant_spots===0 || lot.is_paused"
                                @click="openReserve(lot.lot_id)">
                            Reserve
                        </button>

                        <p v-if="lot.is_paused" class="text-danger mt-2">⚠ Lot Paused</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- RIGHT COLUMN: Non-released Reservations -->
        <div class="col-md-6">
            <h4>Active Reservations</h4>

            <div v-if="activeReservations.length === 0" class="alert alert-secondary">
                No active reservations
            </div>

            <div v-for="r in activeReservations" :key="r.reservation_id" class="card p-3 mb-3 shadow-sm">
                <h6>Reservation ID: {{ r.reservation_id }}</h6>
                <p>Lot ID: {{ r.lot_id }}</p>
                <p>Spot ID: {{ r.spot_id }}</p>
                <p>Vehicle: {{ r.vehicle_number }}</p>
                <p>Reserved At: {{ formatIST(r.reserved_at) }}</p>
                <button class="btn btn-danger w-100" @click="releaseSpot(r.reservation_id)">
                    Release
                </button>
            </div>
        </div>
    </div>

    <!-- POPUP FOR VEHICLE NUMBER -->
    <div v-if="showPopup" class="position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center bg-dark bg-opacity-50">
        <div class="bg-white p-4 rounded shadow" style="width: 350px;">
            <h5>Enter Vehicle Number</h5>
            <input class="form-control mt-2" v-model="vehicle_number" placeholder="WB-12-A-1234">

            <div class="mt-3 d-flex justify-content-between">
                <button class="btn btn-secondary" @click="showPopup=false">Cancel</button>
                <button class="btn btn-primary" @click="reserveSpot">Reserve</button>
            </div>
        </div>
    </div>

</div>

<script>
const { createApp } = Vue;

createApp({
    data() {
        return {
            lots: [],
            token: localStorage.getItem("token"),
            showPopup: false,
            vehicle_number: "",
            selected_lot: null,
            activeReservations: [],
            lotSearchQuery: ""
        };
    },

    computed: {
        filteredLots() {
            if (!this.lotSearchQuery) return this.lots;
            const q = this.lotSearchQuery.toLowerCase();
            return this.lots.filter(lot =>
                lot.location.toLowerCase().includes(q) ||
                String(lot.price).includes(q) ||
                String(lot.vacant_spots).includes(q)
            );
        }
    },

    methods: {
        async loadLots() {
            const res = await fetch("http://127.0.0.1:5000/user/lots", {
                headers: { "Authorization": `Bearer ${this.token}` }
            });
            this.lots = await res.json();
        },

        async loadActiveReservations() {
            const res = await fetch("http://127.0.0.1:5000/user/active", {
                headers: { "Authorization": `Bearer ${this.token}` }
            });
            const data = await res.json();
            this.activeReservations = data;
        },

        openReserve(lotid) {
            this.selected_lot = lotid;
            this.showPopup = true;
        },

        async reserveSpot() {
            const res = await fetch(`http://127.0.0.1:5000/reserve/${this.selected_lot}`, {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${this.token}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ vehicle_number: this.vehicle_number })
            });

            const data = await res.json();
            alert(data.message || data.error);

            if (res.ok) {
                this.showPopup = false;
                this.vehicle_number = "";
                this.loadLots();
                this.loadActiveReservations();
            }
        },

        async releaseSpot(reservation_id) {
            const res = await fetch(`http://127.0.0.1:5000/release/${reservation_id}`, {
                method: "POST",
                headers: { "Authorization": `Bearer ${this.token}` }
            });

            const data = await res.json();
            alert(data.message || data.error);

            if (res.ok) {
                this.loadLots();
                this.loadActiveReservations();
            }
        },

        formatIST(datetimeStr) {
            const dt = new Date(datetimeStr);
            dt.setHours(dt.getHours() + 5);
            dt.setMinutes(dt.getMinutes() + 30);
            return dt.toLocaleString();
        }
    },

    mounted() {
        if (!this.token) window.location.href = "user_login.html";
        this.loadLots();
        this.loadActiveReservations();
    }
}).mount("#app");
</script>
</body>
</html>
